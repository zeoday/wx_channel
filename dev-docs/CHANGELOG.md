# 更新日志

## v5.5.5 - 2026-02-17

### 🚀 性能优化

- **数据库瘦身**: 实现了 `mining` 类型交易记录的自动清理策略，仅保留最近 7 天数据，防止数据库体积无限膨胀。
- **SQLite 调优**: 启用了 WAL (Write-Ahead Logging) 模式和 5000ms 忙碌超时，大幅减少数据库锁竞争，提升并发吞吐量。

### 🖥️ 前端功能

- **服务端分页**: 个人中心积分记录表格升级为服务端分页 (Lazy Loading)，彻底解决历史数据无法加载的问题。
- **UI 修复**: 移除了登录和注册页面中过时的手动定位样式，适配 PrimeVue 组件库，修复图标偏移问题。
- **布局优化**: 强制个人中心统计卡片横向排列，调整最小宽度，优化移动端和低分辨率下的显示效果。
- **导航修正**: 修复了 TopBar 下拉菜单中“个人资料”链接指向错误的 404 页面问题。

### 🔧 系统维护

- **依赖更新**: 前端依赖更新，版本号同步至 `v5.5.5`。

---

## v5.4.0 - 2026-01-24

### 🚀 核心升级

#### Gopeed 下载引擎集成
- ✅ 集成 `Gopeed` 作为底层下载引擎，替代不稳定下载器
- ✅ 支持**断点续传**，网络波动不影响下载
- ✅ 支持**高并发下载**，大幅提升速度
- ✅ 实现 `UploadHandler` 与 `GopeedService` 的混合架构

#### 极致体积优化
- ✅ 二进制体积减少 **66%** (95MB -> 32MB)
- ✅ 移除冗余依赖 (BitTorrent, WebRTC, SQLite)
- ✅ 编译启用 Strip Debug Symbols (`-ldflags="-w -s"`)
- ✅ 清理调试代码 (`debug_panic`) 和辅助脚本

### ✨ 功能增强

#### 下载限制彻底移除
- ✅ **Profile 页面**：采集限制提升至 100,000 条 (原 300)
- ✅ **搜索页面**：采集限制提升至 100,000 条 (原 200)
- ✅ **批量下载器**：队列限制提升至 100,000 条

#### 体验优化
- ✅ **实时进度显示**：支持百分比 + 大小显示 (e.g., `45.2% 15/30MB`)
- ✅ **WebSocket 同步**：后端进度实时推送到前端 UI
- ✅ **立即取消**：支持下载任务的立即中断/取消

### 🔧 修复与优化
- 🐛 修复 `UploadHandler` 空指针 Panic (数据库未初始化)
- 🐛 修复数据库写入 `UNIQUE constraint failed` 错误
- 🔧 禁用调试快照 (`save_page_snapshot=false`)
- 🔧 优化日志输出，移除噪声

---

## v5.3.0 - 2026-01-18

### 新增功能

#### 通用批量下载组件
- ✅ 创建统一的批量下载 UI 组件 (`batch_download.js`)
- ✅ 所有页面（Home、Profile、Search）共用同一套下载逻辑
- ✅ 减少约 400+ 行重复代码

#### 批量下载功能增强
- ✅ 支持强制重新下载选项
- ✅ 支持取消下载功能
- ✅ 实时下载进度显示（进度条 + 文本）
- ✅ 导出视频列表（含解密密钥）
- ✅ 清空列表功能（带确认）
- ✅ 下载完成后进度条自动隐藏（2秒延迟）

#### 视频列表优化
- ✅ 封面尺寸优化为 60x40（16:9 比例）
- ✅ 时长显示在封面右下角（黑色半透明背景）
- ✅ 标题下方显示：文件大小、发布日期、作者昵称
- ✅ 分页显示（50个/页）
- ✅ 全选当前页功能
- ✅ 最多采集 300 个视频

#### Home 页面分类视频下载
- ✅ 识别当前 Tab（美食、生活等分类）
- ✅ 拦截 `finderGetRecommend` API 获取视频数据
- ✅ 数据累积（追加模式，自动去重）
- ✅ 支持滚动加载更多视频
- ✅ 使用通用批量下载组件

#### 搜索页面增强
- ✅ 显示视频和直播数据
- ✅ 直播数据带红色"直播"标签
- ✅ 直播复选框禁用（暂不支持下载）
- ✅ 标题自动清理 HTML 标签（如 `<em class="highlight">`）
- ✅ 使用 `WXU.format_feed()` 统一数据格式

#### Profile 页面集成
- ✅ 使用通用批量下载组件
- ✅ 统一的下载逻辑和 UI
- ✅ 支持视频和直播回放

#### UI 统一优化
- ✅ 所有页面下载按钮统一位置（顶部工具栏最左侧）
- ✅ 统一按钮样式和图标
- ✅ 统一弹窗样式（右上角固定，宽度 450px）
- ✅ 统一背景色和文字颜色

#### 页面快照功能
- ✅ 恢复 `SavePageSnapshot` 功能
- ✅ 保存 HTML 和 metadata 到 `downloads/page_snapshots/YYYY-MM-DD/`
- ✅ 控制台显示保存路径（蓝色标题样式）

### 优化改进

#### 下载逻辑统一
- 🔧 所有页面使用相同的解密和下载逻辑
- 🔧 统一使用 `async/await` 方式
- 🔧 统一的错误处理和成功/跳过/失败计数
- 🔧 添加 HTTP 状态码检查（修复下载成功但显示失败的问题）

#### 数据格式统一
- 🔧 `WXU.format_feed()` 函数增强
- 🔧 支持识别直播数据（`type: "live"`）
- 🔧 添加 `canDownload` 字段标记是否可下载
- 🔧 自动清理标题中的 HTML 标签
- 🔧 统一时长格式（优先使用 `spec[0].durationMs`）

#### 代码优化
- 🧹 移除 Profile 和 Search 页面的旧 UI 代码（未使用）
- 🧹 清理 lib 目录重复文件
- 🧹 优化变量作用域（修复复选框禁用 bug）

### 修复问题

- 🐛 修复搜索页直播数据被过滤的问题
- 🐛 修复下载成功但前端显示失败的问题（缺少 HTTP 状态码检查）
- 🐛 修复视频复选框被错误禁用的问题（变量声明顺序）
- 🐛 修复标题包含 HTML 元素的问题（自动清理）
- 🐛 修复 JSON 解析错误导致 SavePageSnapshot 功能丢失

### 技术细节

#### 通用组件架构
- 全局管理器：`window.__wx_batch_download_manager__`
- 统一 API：`__show_batch_download_ui__()`, `__update_batch_download_ui__()`, `__close_batch_download_ui__()`
- 事件驱动：使用 `WXE` 事件系统获取数据

#### 数据流
1. API 拦截 → 格式化（`WXU.format_feed()`）→ 添加到管理器
2. 管理器 → 渲染 UI → 用户选择 → 批量下载
3. 下载 → 解密 → 保存 → 更新进度

---

## v5.2.11 - 之前版本

### 新增功能

#### 通用批量下载组件
- ✅ 创建统一的批量下载 UI 组件 (`batch_download.js`)
- ✅ 所有页面（Home、Profile、Search）共用同一套下载逻辑
- ✅ 减少约 400+ 行重复代码

#### 批量下载功能增强
- ✅ 支持强制重新下载选项
- ✅ 支持取消下载功能
- ✅ 实时下载进度显示（进度条 + 文本）
- ✅ 导出视频列表（含解密密钥）
- ✅ 清空列表功能（带确认）
- ✅ 下载完成后进度条自动隐藏（2秒延迟）

#### 视频列表优化
- ✅ 封面尺寸优化为 60x40（16:9 比例）
- ✅ 时长显示在封面右下角（黑色半透明背景）
- ✅ 标题下方显示：文件大小、发布日期、作者昵称
- ✅ 分页显示（50个/页）
- ✅ 全选当前页功能
- ✅ 最多采集 300 个视频

#### Home 页面分类视频下载
- ✅ 识别当前 Tab（美食、生活等分类）
- ✅ 拦截 `finderGetRecommend` API 获取视频数据
- ✅ 数据累积（追加模式，自动去重）
- ✅ 支持滚动加载更多视频
- ✅ 使用通用批量下载组件

#### 搜索页面增强
- ✅ 显示视频和直播数据
- ✅ 直播数据带红色"直播"标签
- ✅ 直播复选框禁用（暂不支持下载）
- ✅ 标题自动清理 HTML 标签（如 `<em class="highlight">`）
- ✅ 使用 `WXU.format_feed()` 统一数据格式

#### Profile 页面集成
- ✅ 使用通用批量下载组件
- ✅ 统一的下载逻辑和 UI
- ✅ 支持视频和直播回放

#### UI 统一优化
- ✅ 所有页面下载按钮统一位置（顶部工具栏最左侧）
- ✅ 统一按钮样式和图标
- ✅ 统一弹窗样式（右上角固定，宽度 450px）
- ✅ 统一背景色和文字颜色

#### 页面快照功能
- ✅ 恢复 `SavePageSnapshot` 功能
- ✅ 保存 HTML 和 metadata 到 `downloads/page_snapshots/YYYY-MM-DD/`
- ✅ 控制台显示保存路径（蓝色标题样式）

### 优化改进

#### 下载逻辑统一
- 🔧 所有页面使用相同的解密和下载逻辑
- 🔧 统一使用 `async/await` 方式
- 🔧 统一的错误处理和成功/跳过/失败计数
- 🔧 添加 HTTP 状态码检查（修复下载成功但显示失败的问题）

#### 数据格式统一
- 🔧 `WXU.format_feed()` 函数增强
- 🔧 支持识别直播数据（`type: "live"`）
- 🔧 添加 `canDownload` 字段标记是否可下载
- 🔧 自动清理标题中的 HTML 标签
- 🔧 统一时长格式（优先使用 `spec[0].durationMs`）

#### 代码优化
- 🧹 移除 Profile 和 Search 页面的旧 UI 代码（未使用）
- 🧹 清理 lib 目录重复文件
- 🧹 优化变量作用域（修复复选框禁用 bug）

### 修复问题

- 🐛 修复搜索页直播数据被过滤的问题
- 🐛 修复下载成功但前端显示失败的问题（缺少 HTTP 状态码检查）
- 🐛 修复视频复选框被错误禁用的问题（变量声明顺序）
- 🐛 修复标题包含 HTML 元素的问题（自动清理）
- 🐛 修复 JSON 解析错误导致 SavePageSnapshot 功能丢失

### 技术细节

#### 通用组件架构
- 全局管理器：`window.__wx_batch_download_manager__`
- 统一 API：`__show_batch_download_ui__()`, `__update_batch_download_ui__()`, `__close_batch_download_ui__()`
- 事件驱动：使用 `WXE` 事件系统获取数据

#### 数据流
1. API 拦截 → 格式化（`WXU.format_feed()`）→ 添加到管理器
2. 管理器 → 渲染 UI → 用户选择 → 批量下载
3. 下载 → 解密 → 保存 → 更新进度

---

## v1.0.0 - 2026-01-17

### 新增功能

#### HTTP API 接口
- ✅ 完整的 WebSocket + HTTP API 架构
- ✅ 搜索账号 API (`/api/channels/contact/search`)
- ✅ 获取账号视频列表 API (`/api/channels/contact/feed/list`)
- ✅ 获取视频详情 API (`/api/channels/feed/profile`)
- ✅ 查询连接状态 API (`/api/channels/status`)

#### API 对象创建
- ✅ 自动拦截微信 JavaScript 代码
- ✅ 提取并暴露 `WXU.API` 和 `WXU.API2` 对象
- ✅ 支持所有微信视频号原生 API 函数

#### WebSocket 通信
- ✅ 稳定的 WebSocket 连接池
- ✅ 自动重连机制
- ✅ 请求/响应匹配
- ✅ 超时处理

### 优化改进

#### 代码清理
- 🧹 移除详细的调试日志
- 🧹 保留关键的错误日志
- 🧹 简化日志输出
- 🧹 删除测试代码和文件

#### 文档整理
- 📚 精简 API 文档
- 📚 创建快速开始指南
- 📚 添加使用示例
- 📚 完善故障排查说明

### 技术细节

#### 后端 (Go)
- WebSocket Hub 管理连接池
- HTTP API 服务处理请求
- 自动选择最新的客户端连接
- 20秒请求超时

#### 前端 (JavaScript)
- 自动连接和重连
- 多端口尝试连接
- API 对象自动初始化
- 错误处理和重试

### 已知限制

1. 必须先打开微信视频号页面才能使用 API
2. 需要使用 `username` 而不是 `nickname`
3. 建议请求间隔 0.5-1 秒
4. 单个 WebSocket 连接处理所有请求

### 下一步计划

- [ ] 添加请求缓存机制
- [ ] 支持批量 API 调用
- [ ] 添加 API 速率限制
- [ ] 创建独立的客户端库
- [ ] 支持更多 API 端点

---

**完整文档**: 
- `API_README.md` - API 功能简介
- `API_QUICK_START.md` - 快速开始指南
- `docs/API_SEARCH_GUIDE.md` - 详细 API 文档
